<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.css" integrity="sha512-MKxcSu/LDtbIYHBNAWUQwfB3iVoG9xeMCm32QV5hZ/9lFaQZJVaXfz9aFa0IZExWzCpm7OWvp9zq9gVip/nLMg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<style>
  #loading {
  position: fixed;
  display: flex;
  top: 0;
  z-index: 9999;
  width: 100vw;
  height: 100vh;
  background: rgba(0,0,0,0.6);
}
</style>
</head>
<body>
  <center>
    <div id="loading">
      <div class="spinner-border m-auto" style="width: 5rem; height: 5rem;" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>
    <div class="sticky-top bg-white">
      <h1 class="h1">RGB 채널</h1>
      <div class="row">
        <div class="col-md-3"></div>
        <div class="col-md-3">
          <input type="file" id="fileInput" name="file" />
        </div>
        <div class="col-md-3" id="slider"></div>
        <div class="col-md-3"></div>
      </div>
    </div>
<div>
  <div class="my-2" id="input">
    <img id="imageSrc" alt="No Image" src="./tomato.jpg" hidden/>
    <canvas class="w-100" id="canvasOutput"></canvas>
  </div>
</div>
</center>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.5.1/nouislider.min.js" integrity="sha512-T5Bneq9hePRO8JR0S/0lQ7gdW+ceLThvC80UjwkMRz+8q+4DARVZ4dqKoyENC7FcYresjfJ6ubaOgIE35irf4w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script type="text/javascript">
var slider = document.getElementById('slider');

noUiSlider.create(slider, {
    start: [0, 180],
    connect: true,
    tooltips: true,
    format: {
        to: (v) => parseInt(v),
        from: (v) => parseInt(v)
    },
    step: 1,
    range: {
        'min': 0,
        'max': 180
    }
});


let imgElement = document.getElementById('imageSrc');
let inputElement = document.getElementById('fileInput');
inputElement.addEventListener('change', (e) => {
  imgElement.src = URL.createObjectURL(e.target.files[0]);
}, false);

function callback(values) {
  console.log(values);
  let src = cv.imread('imageSrc');
  let hsv = new cv.Mat();
  let dst = new cv.Mat();
  let mask = new cv.Mat();
  cv.cvtColor(src, hsv, cv.COLOR_RGB2HSV);
  let low = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [values[0], 0,0, 0]);
  let high = new cv.Mat(hsv.rows, hsv.cols, hsv.type(), [values[1], 255, 255, 255]);
  let zeros = new cv.Mat(src.rows, src.cols, src.type(), [0, 0, 0, 0]);
  cv.inRange(hsv, low, high, mask);
  cv.subtract(src, zeros, dst, mask);
  cv.imshow('canvasOutput', dst);
  low.delete();
  high.delete();
  hsv.delete();
  dst.delete();
  src.delete();
  mask.delete();
  zeros.delete();
}

function onOpenCvReady() {
  cv['onRuntimeInitialized']=()=>{
    document.getElementById('loading').remove();
    slider.noUiSlider.on('change', callback);
    let src = cv.imread('imageSrc');
    cv.imshow('canvasOutput', src);
    src.delete();
  };
}
</script>
<script async src="https://docs.opencv.org/3.4/opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>
